
FROM docker:25 AS docker-cli

FROM node:20-bookworm

# Copiar Docker CLI do estÃ¡gio anterior
COPY --from=docker-cli /usr/local/bin/docker /usr/local/bin/docker

# Configurar locale e timezone
RUN apt-get update && apt-get install -y \
    locales \
    tzdata \
    bash \
    curl \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Configurar locale para pt_BR.UTF-8
RUN sed -i '/^#.* pt_BR.UTF-8 /s/^#//' /etc/locale.gen && \
    locale-gen && \
    echo "LANG=pt_BR.UTF-8" > /etc/default/locale

# Configurar timezone para America/Bahia
RUN ln -fs /usr/share/zoneinfo/America/Bahia /etc/localtime && \
    echo "America/Bahia" > /etc/timezone && \
    dpkg-reconfigure -f noninteractive tzdata

# Definir variÃ¡veis de ambiente
ENV LANG=pt_BR.UTF-8
ENV LC_ALL=pt_BR.UTF-8
ENV TZ=America/Bahia
ENV NODE_ENV=production
ENV PORT=3001
ENV DATA_DIR=/app/data
ENV SCRIPTS_DIR=/app/scripts
ENV LOGS_DIR=/app/logs
ENV UPLOADS_DIR=/app/uploads

# Executar como root
USER root

WORKDIR /app

# Criar diretÃ³rios necessÃ¡rios
RUN mkdir -p /app/data /app/scripts /app/logs /app/uploads

# Copiar arquivos do backend
COPY package*.json ./
RUN npm install --omit=dev

# Copiar cÃ³digo fonte
COPY . .

# Criar script de inicializaÃ§Ã£o inline
RUN cat > /app/init.sh << 'EOF'
#!/bin/bash

echo "ðŸš€ Iniciando configuraÃ§Ã£o do sistema de produÃ§Ã£o..."

# FunÃ§Ã£o para log colorido
log() {
    echo -e "\033[32m[$(date '+%Y-%m-%d %H:%M:%S')] $1\033[0m"
}

error() {
    echo -e "\033[31m[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1\033[0m"
}

warning() {
    echo -e "\033[33m[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: $1\033[0m"
}

# Verificar se Ã© primeira execuÃ§Ã£o
FIRST_RUN_FILE="/app/data/.first_run_complete"

# Aguardar um pouco para outros serviÃ§os iniciarem
sleep 5

if [ ! -f "$FIRST_RUN_FILE" ]; then
    log "ðŸŽ¯ Primeira execuÃ§Ã£o detectada - configurando sistema..."
    
    # Criar diretÃ³rios necessÃ¡rios
    log "ðŸ“ Criando estrutura de diretÃ³rios..."
    mkdir -p /app/data /app/scripts /app/logs /app/uploads
    
    # Definir permissÃµes
    log "ðŸ”’ Configurando permissÃµes..."
    chmod 755 /app/data /app/scripts /app/logs /app/uploads
    
    # Criar configuraÃ§Ã£o inicial do sistema
    log "âš™ï¸ Criando configuraÃ§Ã£o inicial..."
    cat > /app/data/system-config.json << EOJ
{
  "version": "1.0.0",
  "initialized": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
  "environment": "${NODE_ENV:-production}",
  "domain": "${DOMAIN:-localhost}",
  "basePath": "${BASE_PATH:-}",
  "users": {
    "administrador": "${ADMIN_PASSWORD:-admin123}",
    "usuario": "${USER_PASSWORD:-user123}"
  },
  "customizations": {
    "title": "${SYSTEM_TITLE:-PAINEL DE CONTROLE}",
    "subtitle": "${SYSTEM_SUBTITLE:-Sistema de Gerenciamento Docker}",
    "background": "",
    "logo": "",
    "favicon": ""
  },
  "systemVariables": {
    "NODE_ENV": "${NODE_ENV:-production}",
    "DOMAIN": "${DOMAIN:-localhost}",
    "BASE_PATH": "${BASE_PATH:-}",
    "CORS_ORIGIN": "${CORS_ORIGIN:-*}"
  },
  "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
}
EOJ
    
    # Configurar logs iniciais
    log "ðŸ“ Configurando logs do sistema..."
    cat > /app/logs/system.log << EOL
[$(date '+%Y-%m-%d %H:%M:%S')] Sistema inicializado em produÃ§Ã£o
[$(date '+%Y-%m-%d %H:%M:%S')] DomÃ­nio: ${DOMAIN:-localhost}
[$(date '+%Y-%m-%d %H:%M:%S')] Base Path: ${BASE_PATH:-/}
[$(date '+%Y-%m-%d %H:%M:%S')] Ambiente: ${NODE_ENV:-production}
EOL
    
    # Marcar primeira execuÃ§Ã£o como concluÃ­da
    touch "$FIRST_RUN_FILE"
    echo "$(date '+%Y-%m-%d %H:%M:%S')" > "$FIRST_RUN_FILE"
    log "âœ… ConfiguraÃ§Ã£o inicial concluÃ­da!"
else
    log "ðŸ”„ Sistema jÃ¡ configurado - carregando configuraÃ§Ãµes existentes..."
fi

# Verificar conectividade com Docker
log "ðŸ³ Verificando conectividade com Docker..."
if docker version > /dev/null 2>&1; then
    log "âœ… Docker conectado com sucesso"
    docker --version | sed 's/^/   â€¢ /'
else
    error "âŒ NÃ£o foi possÃ­vel conectar ao Docker"
    warning "Verifique se o socket do Docker estÃ¡ montado corretamente"
fi

# Verificar e criar volumes se necessÃ¡rio
log "ðŸ’¾ Verificando volumes de dados..."
for dir in data scripts logs uploads; do
    if [ -d "/app/$dir" ] && [ -w "/app/$dir" ]; then
        log "   âœ… Volume $dir: OK"
    else
        warning "   âš ï¸ Volume $dir: Problema de acesso"
        mkdir -p "/app/$dir" 2>/dev/null || true
        chmod 755 "/app/$dir" 2>/dev/null || true
    fi
done

# Exibir informaÃ§Ãµes do sistema
log "ðŸ“Š InformaÃ§Ãµes do sistema:"
log "   â€¢ Hostname: $(hostname)"
log "   â€¢ Ambiente: ${NODE_ENV:-development}"
log "   â€¢ Porta: ${PORT:-3001}"
log "   â€¢ DomÃ­nio: ${DOMAIN:-localhost}"
log "   â€¢ Base Path: ${BASE_PATH:-/}"

# Executar servidor
log "ðŸš€ Iniciando servidor Node.js..."
log "Sistema pronto para uso em: ${DOMAIN:-localhost}${BASE_PATH:-}"

exec node server.js
EOF

# Dar permissÃµes
RUN chmod +x /app/init.sh
RUN chmod -R 755 /app/scripts 2>/dev/null || true
RUN chmod -R 755 /app/logs 2>/dev/null || true
RUN chmod -R 755 /app/data 2>/dev/null || true
RUN chmod -R 755 /app/uploads 2>/dev/null || true

# Expor porta
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3001/api/health || exit 1

# Comando de entrada
CMD ["/app/init.sh"]
